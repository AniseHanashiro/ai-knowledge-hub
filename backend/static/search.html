<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>AI Search - AI Knowledge Hub</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="navbar">
        <div style="font-size: 1.2rem; font-weight: bold;">ğŸ§  AI Knowledge Hub</div>
        <div class="nav-links">
            <a href="/index.html">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a href="/timeline.html">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</a>
            <a href="/search.html" class="active">AIæ¤œç´¢</a>
            <a href="/following.html">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</a>
            <a href="/clips.html">ã‚¯ãƒªãƒƒãƒ—</a>
        </div>
        <button class="btn-collect" onclick="runCollect()">ğŸ”„ åé›†å®Ÿè¡Œ</button>
    </div>

    <div class="container" style="flex-direction: column; max-width: 1000px;">

        <h2>âœ¨ Gemini AI Search</h2>
        <p style="color: var(--text2)">è‡ªç„¶è¨€èªã§è¨˜äº‹ã‚„å‹•ç”»ã‚’æ¤œç´¢ã—ã€AIãŒæ–‡è„ˆã‚’è§£é‡ˆã—ã¦é–¢é€£é †ã«å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã—ã¾ã™ã€‚</p>

        <div style="margin-top: 1rem;">
            <input type="text" id="ai-search-input" class="search-bar" placeholder="ä¾‹: NotebookLMã«ã¤ã„ã¦è©±ã—ã¦ã„ã‚‹æ—¥æœ¬èªã®Youtubeå‹•ç”»"
                onkeypress="if(event.key === 'Enter') doSearch()">
        </div>

        <div class="quick-searches">
            <button class="quick-search-btn" onclick="setQuery('å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã®æœ€æ–°å‹•å‘')">å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã®æœ€æ–°å‹•å‘</button>
            <button class="quick-search-btn" onclick="setQuery('OpenAIã®ãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥ã«ã¤ã„ã¦ã®è¨˜äº‹')">OpenAIã®ãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥ã«ã¤ã„ã¦ã®è¨˜äº‹</button>
            <button class="quick-search-btn" onclick="setQuery('RAG (æ¤œç´¢æ‹¡å¼µç”Ÿæˆ) ã®å®Ÿè·µçš„ãªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å‹•ç”»')">RAG (æ¤œç´¢æ‹¡å¼µç”Ÿæˆ)
                ã®å®Ÿè·µå‹•ç”»</button>
            <button class="quick-search-btn" onclick="setQuery('ç”»åƒç”ŸæˆAIã®è‘—ä½œæ¨©å•é¡Œ')">ç”»åƒç”ŸæˆAIã®è‘—ä½œæ¨©å•é¡Œ</button>
        </div>

        <div id="loading" style="display: none; text-align: center; padding: 2rem; color: var(--accent);">
            <h3>AIæ¨è«–ä¸­... ğŸ¤– ğŸ’­</h3>
        </div>

        <div id="ai-parsed-result"
            style="margin-bottom: 2rem; display:none; background: var(--bg2); padding: 1rem; border-radius: 8px;">
            <h4 style="margin-top:0;">ğŸ” æ¤œç´¢æ¡ä»¶ã®è§£é‡ˆ:</h4>
            <pre id="parsed-json" style="color: var(--text2); font-size: 0.85rem; overflow-x: auto;"></pre>
        </div>

        <div class="card-grid" id="search-results">
            <!-- Results here -->
        </div>

    </div>

    <script>
        function setQuery(q) {
            document.getElementById('ai-search-input').value = q;
            doSearch();
        }

        async function doSearch() {
            const q = document.getElementById('ai-search-input').value;
            if (!q) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('ai-parsed-result').style.display = 'none';

            try {
                const res = await fetch('/api/search/ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: q })
                });
                const data = await res.json();

                document.getElementById('loading').style.display = 'none';

                if (data.parsed_query) {
                    document.getElementById('ai-parsed-result').style.display = 'block';
                    document.getElementById('parsed-json').innerText = JSON.stringify(data.parsed_query, null, 2);
                }

                const container = document.getElementById('search-results');
                if (!data.results || data.results.length === 0) {
                    container.innerHTML = '<p>çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                    return;
                }

                container.innerHTML = data.results.map(a => `
            <div class="card" style="border: 2px solid var(--border)">
                ${a.relevance_note ? `<div class="ai-reason">âœ¨ <b>AI Note:</b> ${a.relevance_note}</div>` : ''}
                <div>
                    <span class="badge badge-${a.priority_label}">${a.priority_label}</span>
                    <span class="badge badge-MEDIUM">AI Score: ${a.ai_rank_score || 0}</span>
                </div>
                <a href="${a.url}" target="_blank" class="card-title">${a.title}</a>
                <div class="card-summary">${a.summary_ja}</div>
            </div>
        `).join('');
            } catch (e) {
                document.getElementById('loading').style.display = 'none';
                alert('æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚GEMINI_API_KEY ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                console.error(e);
            }
        }

        async function runCollect() {
            alert("ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åé›†ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
            await fetch('/api/collect', { method: 'POST' });
        }
    </script>
</body>

</html>