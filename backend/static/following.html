<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Following - AI Knowledge Hub</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="navbar">
        <div style="font-size: 1.2rem; font-weight: bold;">🧠 AI Knowledge Hub</div>
        <div class="nav-links">
            <a href="/index.html">ダッシュボード</a>
            <a href="/timeline.html">タイムライン</a>
            <a href="/search.html">AI検索</a>
            <a href="/following.html" class="active">フォロー中</a>
            <a href="/clips.html">クリップ</a>
        </div>
        <button class="btn-collect" onclick="runCollect()">🔄 収集実行</button>
    </div>

    <div class="container" style="flex-direction: column; max-width: 1000px;">

        <div
            style="background:var(--bg2); padding:2rem; border-radius:8px; margin-bottom:2rem; border:1px solid var(--border);">
            <h2>🤖 NotebookLM 連携用フィード (Atom/RSS)</h2>
            <p style="color:var(--text2)">
                このURLをNotebookLMのソースとして追加すると、AIが高く評価した記事(スコア55以上)を自動で連携できます。<br />※外部からアクセス可能なホスト名(Railway等のURL)に置き換えて使用してください。
            </p>
            <div style="display:flex; gap:1rem; align-items:center;">
                <input type="text" id="feed-url" value="http://localhost:8000/feed/public" readonly
                    style="flex:1; padding:0.5rem; background:var(--bg); color:var(--text); border:1px solid var(--accent); border-radius:4px;">
                <button class="btn-secondary" onclick="copyFeed()">コピー</button>
            </div>
        </div>

        <h2>📡 フォロー中のソース</h2>

        <div style="margin-bottom:2rem; background:var(--bg2); padding:1rem; border-radius:8px;">
            <h4>+ ソースを追加</h4>
            <div style="display:flex; gap:1rem;">
                <input type="text" id="new-url" placeholder="RSSのURL または YouTubeチャンネルID"
                    style="flex:1; padding:0.5rem; border-radius:4px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                <button class="btn-collect" onclick="addSource()">追加</button>
            </div>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>種別</th>
                    <th>名前/URL</th>
                    <th>状態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="sources-body">
                <!-- Sources here -->
            </tbody>
        </table>

    </div>

    <script>
        async function loadSources() {
            const res = await fetch('/api/sources');
            const sources = await res.json();
            const tbody = document.getElementById('sources-body');

            tbody.innerHTML = sources.map(s => `
        <tr>
            <td><span class="badge" style="background:var(--bg3); border:1px solid var(--border);">${s.type}</span></td>
            <td>
                <div style="font-weight:bold">${s.display_name}</div>
                <div style="font-size:0.8rem; color:var(--text2)">${s.url}</div>
            </td>
            <td>
                <label>
                    <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="toggleSource(${s.id}, this.checked)">
                    有効
                </label>
            </td>
            <td>
                <button class="btn-danger" onclick="deleteSource(${s.id})">削除</button>
            </td>
        </tr>
    `).join('');
        }

        async function addSource() {
            const url = document.getElementById('new-url').value;
            if (!url) return;
            await fetch('/api/sources', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });
            document.getElementById('new-url').value = '';
            loadSources();
        }

        async function toggleSource(id, checked) {
            await fetch(`/api/sources/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: checked })
            });
        }

        async function deleteSource(id) {
            if (!confirm('本当に削除しますか？')) return;
            await fetch(`/api/sources/${id}`, { method: 'DELETE' });
            loadSources();
        }

        function copyFeed() {
            // Determine current origin to build the proper URL
            const url = window.location.origin + '/feed/public';
            navigator.clipboard.writeText(url);
            alert('コピーしました: ' + url);
        }

        async function runCollect() {
            alert("バックグラウンドで収集を開始します。");
            await fetch('/api/collect', { method: 'POST' });
        }

        window.onload = () => {
            document.getElementById('feed-url').value = window.location.origin + '/feed/public';
            loadSources();
        };
    </script>
</body>

</html>