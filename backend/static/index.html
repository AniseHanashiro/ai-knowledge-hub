<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>AI Knowledge Hub</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="navbar">
        <div style="font-size: 1.2rem; font-weight: bold;">ğŸ§  AI Knowledge Hub</div>
        <div class="nav-links">
            <a href="/index.html" class="active">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a href="/timeline.html">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</a>
            <a href="/search.html">AIæ¤œç´¢</a>
            <a href="/following.html">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</a>
            <a href="/clips.html">ã‚¯ãƒªãƒƒãƒ—</a>
        </div>
        <button class="btn-collect" onclick="runCollect()">ğŸ”„ åé›†å®Ÿè¡Œ</button>
    </div>

    <div class="container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="sidebar">

            <div class="filter-section">
                <div class="filter-title">ã‚«ãƒ†ã‚´ãƒª</div>
                <ul class="filter-list" id="filter-category">
                    <li class="active" onclick="setFilter('category', '', this)">ã™ã¹ã¦</li>
                    <li onclick="setFilter('category', 'LLM', this)">LLM</li>
                    <li onclick="setFilter('category', 'ç”»åƒç”Ÿæˆ', this)">ç”»åƒç”Ÿæˆ</li>
                    <li onclick="setFilter('category', 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ', this)">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</li>
                    <li onclick="setFilter('category', 'é–‹ç™ºãƒ„ãƒ¼ãƒ«', this)">é–‹ç™ºãƒ„ãƒ¼ãƒ«</li>
                    <li onclick="setFilter('category', 'ç ”ç©¶', this)">ç ”ç©¶</li>
                    <li onclick="setFilter('category', 'ãƒ“ã‚¸ãƒã‚¹', this)">ãƒ“ã‚¸ãƒã‚¹</li>
                    <li onclick="setFilter('category', 'å…¨èˆ¬', this)">å…¨èˆ¬</li>
                </ul>
            </div>

            <div class="filter-section">
                <div class="filter-title">å„ªå…ˆåº¦</div>
                <ul class="filter-list" id="filter-priority">
                    <li class="active" onclick="setFilter('priority', '', this)">ã™ã¹ã¦</li>
                    <li onclick="setFilter('priority', 'BREAKING', this)">ğŸš¨ BREAKING</li>
                    <li onclick="setFilter('priority', 'HOT', this)">ğŸ”¥ HOT</li>
                    <li onclick="setFilter('priority', 'HIGH', this)">â­ HIGH</li>
                    <li onclick="setFilter('priority', 'MEDIUM', this)">ğŸ”¹ MEDIUM</li>
                    <li onclick="setFilter('priority', 'LOW', this)">âšª LOW</li>
                </ul>
            </div>

            <div class="filter-section">
                <div class="filter-title">ã‚½ãƒ¼ã‚¹ç¨®åˆ¥</div>
                <ul class="filter-list" id="filter-source">
                    <li class="active" onclick="setFilter('source', '', this)">ã™ã¹ã¦</li>
                    <li onclick="setFilter('source', 'rss', this)">RSS / è¨˜äº‹</li>
                    <li onclick="setFilter('source', 'youtube', this)">YouTube</li>
                </ul>
            </div>

            <div class="filter-section">
                <div class="filter-title">æœŸé–“</div>
                <ul class="filter-list" id="filter-days">
                    <li onclick="setFilter('days', '1', this)">ä»Šæ—¥</li>
                    <li class="active" onclick="setFilter('days', '7', this)">1é€±é–“</li>
                    <li onclick="setFilter('days', '30', this)">1ãƒ¶æœˆ</li>
                </ul>
            </div>

        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">

            <div class="stats-bar" id="stats-container">
                <!-- Stats loaded via JS -->
            </div>

            <div id="empty-state" class="empty-state" style="display: none;">
                ğŸ“­ è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸Šã®ã€Œåé›†å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
            </div>

            <div class="card-grid" id="articles-container">
                <!-- Articles here -->
            </div>

            <button id="load-more-btn" class="load-more" style="display: none;" onclick="loadMore()">ã•ã‚‰ã«èª­ã¿è¾¼ã‚€</button>

        </div>
    </div>

    <script>
        let currentFilters = {
            category: '',
            priority: '',
            source: '',
            days: '7'
        };
        let currentOffset = 0;
        const LIMIT = 20;

        function setFilter(type, value, element) {
            currentFilters[type] = value;

            // Highlight active list item
            const list = element.parentElement;
            for (let li of list.children) {
                li.classList.remove('active');
            }
            element.classList.add('active');

            // Reset offset and reload
            currentOffset = 0;
            document.getElementById('articles-container').innerHTML = '';
            loadArticles();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();

                document.getElementById('stats-container').innerHTML = `
            <div class="stat-group">
                <div class="stat-item"><span class="stat-value">${stats.articles}</span><span class="stat-label">åˆè¨ˆè¨˜äº‹æ•°</span></div>
                <div class="stat-item"><span class="stat-value" style="color:var(--trust-high);">${stats.today_articles || 0}</span><span class="stat-label">ä»Šæ—¥ã®è¨˜äº‹æ•°</span></div>
            </div>
            <div class="priority-badges-container">
                <span class="badge badge-BREAKING">BREAKING</span>
                <span class="badge badge-HOT">HOT</span>
                <span class="badge badge-HIGH">HIGH</span>
            </div>
        `;
            } catch (e) {
                console.error("Failed to load stats", e);
            }
        }

        function formatDate(dateString) {
            if (!dateString) return "";
            const d = new Date(dateString);
            return d.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        async function loadArticles() {
            let url = `/api/articles?days=${currentFilters.days}&offset=${currentOffset}`;
            if (currentFilters.category) url += `&category=${currentFilters.category}`;
            if (currentFilters.priority) url += `&priority=${currentFilters.priority}`;
            if (currentFilters.source) url += `&source_type=${currentFilters.source}`;

            try {
                const res = await fetch(url);
                const articles = await res.json();
                const container = document.getElementById('articles-container');
                const emptyState = document.getElementById('empty-state');
                const loadMoreBtn = document.getElementById('load-more-btn');

                if (currentOffset === 0 && articles.length === 0) {
                    emptyState.style.display = 'block';
                    loadMoreBtn.style.display = 'none';
                    return;
                }

                emptyState.style.display = 'none';

                const html = articles.map(a => `
            <div class="card">
                <div class="card-badges">
                    <span class="badge badge-${a.priority_label}">${a.priority_label}</span>
                    <span class="badge badge-category">${a.category}</span>
                    <span class="badge badge-source">${a.source_name}</span>
                </div>
                <a href="${a.url}" target="_blank" class="card-title">${a.title}</a>
                <div class="card-summary">${a.summary_ja}</div>
                
                <div class="card-tags">
                    ${(a.tags || []).slice(0, 3).map(t => `<span class="tag">${t}</span>`).join('')}
                </div>
                
                ${a.business_point ? `<div class="business-point">ğŸ’¡ ${a.business_point}</div>` : ''}
                
                <div class="card-footer">
                    <div>
                        <span style="font-weight:bold; color:var(--text);">â˜… ${a.score}</span> 
                        <span style="margin:0 0.4rem; color:var(--border);">|</span> 
                        <span class="trust-${a.trust_level}">ä¿¡é ¼åº¦: ${a.trust_level}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:1rem;">
                        <span>${formatDate(a.published_at)}</span>
                        <button class="clip-btn ${a.is_clipped ? 'clipped' : ''}" onclick="toggleClip(${a.id}, this)">
                          ${a.is_clipped ? 'â˜…' : 'â˜†'}
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

                if (currentOffset === 0) {
                    container.innerHTML = html;
                } else {
                    container.innerHTML += html;
                }

                if (articles.length === LIMIT) {
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            } catch (e) {
                console.error("Failed to load articles", e);
            }
        }

        function loadMore() {
            currentOffset += LIMIT;
            loadArticles();
        }

        async function toggleClip(id, btn) {
            const isClipped = btn.classList.contains('clipped');
            if (isClipped) {
                await fetch(`/api/articles/${id}/clip`, { method: 'DELETE' });
                btn.classList.remove('clipped');
                btn.innerText = 'â˜†';
            } else {
                await fetch(`/api/articles/${id}/clip`, { method: 'POST' });
                btn.classList.add('clipped');
                btn.innerText = 'â˜…';
            }
        }

        async function runCollect() {
            alert("ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åé›†ã‚’é–‹å§‹ã—ã¾ã™ã€‚2ã€œ3åˆ†å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
            await fetch('/api/collect', { method: 'POST' });
        }

        window.onload = () => {
            loadStats();
            loadArticles();
        };
    </script>
</body>

</html>